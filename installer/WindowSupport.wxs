<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Product Id="*"
           Name="Window Support Monitor"
           Language="1033"
           Version="2.0.0"
           Manufacturer="Window Support"
           UpgradeCode="6D8C3A9A-3D47-4C0B-9F8C-5F4E9D7B2C11">

    <Package InstallerVersion="500"
             Compressed="yes"
             InstallScope="perUser"
             InstallPrivileges="limited"
             Description="Window Support Monitor - Employee Activity Tracking"
             Comments="Monitors and tracks employee activity"/>

    <MediaTemplate EmbedCab="yes"/>

    <!-- Major Upgrade -->
    <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="LocalAppDataFolder">
        <Directory Id="INSTALLDIR" Name="WindowSupport">
          
          <!-- Main Provider EXE -->
          <Component Id="cmpProviderExe" Guid="7A8B4C9D-1E2F-4A5B-8C6D-9E7F8A1B2C3D">
            <File Id="filProviderExe" 
                  Source="..\dist\WindowPowerShellProvider.exe" 
                  KeyPath="yes"/>
          </Component>

          <!-- Guardian Service EXE -->
          <Component Id="cmpGuardianExe" Guid="8B9C5D0E-2F3A-5B6C-9D7E-0F8A9B2C3D4E">
            <File Id="filGuardianExe" 
                  Source="..\dist\WindowSupportGuardian.exe" 
                  KeyPath="yes"/>
          </Component>

          <!-- Staff ID Selector EXE -->
          <Component Id="cmpGetIdExe" Guid="9C0D6E1F-3A4B-6C7D-0E8F-1A9B0C3D4E5F">
            <File Id="filGetIdExe" 
                  Source="..\dist\get_your_staff_id.exe" 
                  KeyPath="yes"/>
          </Component>

        </Directory>
      </Directory>
    </Directory>

    <!-- Features -->
    <Feature Id="MainFeature" Title="Window Support Monitor" Level="1" 
             Description="Main application components"
             ConfigurableDirectory="INSTALLDIR">
      <ComponentRef Id="cmpProviderExe"/>
      <ComponentRef Id="cmpGuardianExe"/>
      <ComponentRef Id="cmpGetIdExe"/>
    </Feature>

    <!-- Custom Actions -->
    <CustomAction Id="RunStaffIdSelector" 
                  FileKey="filGetIdExe" 
                  ExeCommand="" 
                  Execute="deferred" 
                  Return="asyncNoWait"
                  Impersonate="yes"/>

    <CustomAction Id="InstallGuardianService"
                  FileKey="filGuardianExe"
                  ExeCommand="install"
                  Execute="deferred"
                  Return="ignore"
                  Impersonate="no"/>

    <CustomAction Id="StartGuardianService"
                  FileKey="filGuardianExe"
                  ExeCommand="start"
                  Execute="deferred"
                  Return="ignore"
                  Impersonate="no"/>

    <CustomAction Id="UninstallGuardianService"
                  FileKey="filGuardianExe"
                  ExeCommand="remove"
                  Execute="deferred"
                  Return="ignore"
                  Impersonate="no"/>

    <CustomAction Id="RunMainProvider"
                  FileKey="filProviderExe"
                  ExeCommand=""
                  Execute="deferred"
                  Return="asyncNoWait"
                  Impersonate="yes"/>

    <!-- Install Sequence -->
    <InstallExecuteSequence>
      <!-- Run Staff ID Selector after files are installed -->
      <Custom Action="RunStaffIdSelector" After="InstallFiles">NOT Installed</Custom>
      
      <!-- Install and start Guardian service (requires admin) -->
      <Custom Action="InstallGuardianService" After="RunStaffIdSelector">NOT Installed</Custom>
      <Custom Action="StartGuardianService" After="InstallGuardianService">NOT Installed</Custom>
      
      <!-- Run main provider once to create scheduled task -->
      <Custom Action="RunMainProvider" After="StartGuardianService">NOT Installed</Custom>
      
      <!-- Uninstall Guardian service on removal -->
      <Custom Action="UninstallGuardianService" Before="RemoveFiles">Installed AND NOT UPGRADINGPRODUCTCODE</Custom>
    </InstallExecuteSequence>

    <!-- UI -->
    <UIRef Id="WixUI_InstallDir"/>
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLDIR"/>
    
    <!-- License -->
    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />

  </Product>
</Wix>
